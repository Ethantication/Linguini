<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linguini - Technion Educational Site</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7; /* New: Very light, warm off-white */
            color: #5c4b5c; /* New: Deep, slightly purplish-gray for main text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff; /* Keep white for content contrast */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"], textarea, select {
            border: 1px solid #d1d5db; /* New: Light gray border */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #34d399; /* New: emerald-400 for focus */
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.2); /* New: emerald-400 shadow */
        }
        button {
            background-color: #88b04b; /* New: Accent green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #6b8e23; /* New: Darker green on hover */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background-color: #a2b9bc; /* New: Muted blue-gray */
        }
        .btn-secondary:hover {
            background-color: #8b9b9e; /* New: Darker muted blue-gray on hover */
        }
        .btn-validate {
            background-color: #10b981; /* emerald-500 - keep green */
        }
        .btn-validate:hover {
            background-color: #059669; /* emerald-600 - keep green */
        }
        .btn-edit {
            background-color: #f97316; /* orange-500 - keep */
        }
        .btn-edit:hover {
            background-color: #ea580c; /* orange-600 - keep */
        }
        .btn-delete {
            background-color: #ef4444; /* red-500 - keep */
        }
        .btn-delete:hover {
            background-color: #dc2626; /* red-600 - keep */
        }
        .status-pending {
            color: #f59e0b; /* amber-500 */
            font-weight: 500;
        }
        .status-validated {
            color: #10b981; /* emerald-500 */
            font-weight: 500;
        }
        .status-not-provided {
            color: #94a3b8; /* slate-400 */
            font-style: italic;
        }
        .status-overall-fully-validated {
            color: #059669; /* green-700 */
            font-weight: 600;
        }
        .status-overall-partially-validated {
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .status-overall-pending {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            min-width: 300px;
        }
        .message-box-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Table styling for terms */
        .term-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .term-table th, .term-table td {
            border: 1px solid #e2e8f0; /* gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        .term-table th {
            background-color: #f8fafc; /* very light off-white */
            font-weight: 600;
            color: #5c4b5c; /* New: primary text color */
        }

        /* Custom header background color */
        .bg-header-custom {
            background-color: #faeddb;
        }

        /* Game specific styles (Linguini Challenge) */
        .challenge-option-button {
            @apply bg-emerald-500 text-white py-3 px-6 rounded-lg text-xl font-semibold w-full transition-all duration-200 ease-in-out;
        }
        .challenge-option-button:hover {
            @apply bg-emerald-600 transform scale-105;
        }
        .challenge-option-button.correct {
            @apply bg-emerald-500;
        }
        .challenge-option-button.incorrect {
            @apply bg-red-500;
        }

        /* Learn Hebrew Game specific styles */
        .learn-hebrew-option-button {
            @apply bg-emerald-500 text-white py-3 px-6 rounded-lg text-xl font-semibold w-full transition-all duration-200 ease-in-out;
        }
        .learn-hebrew-option-button:hover {
            @apply bg-emerald-600 transform scale-105;
        }
        .learn-hebrew-option-button.correct {
            @apply bg-emerald-500;
        }
        .learn-hebrew-option-button.incorrect {
            @apply bg-red-500;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-header-custom text-white p-4 shadow-lg">
        <div class="container flex flex-col md:flex-row md:justify-between md:items-center">
            <!-- Logo on the left -->
            <div class="flex justify-center md:justify-start mb-4 md:mb-0">
                <img src="https://raw.githubusercontent.com/Ethantication/Linguini/main/lingimg.jpg" alt="Linguini Logo" class="h-24 w-24 md:h-20 md:w-20 rounded-full">
            </div>
            <!-- Navigation buttons below on mobile, to the right on desktop -->
            <nav class="flex flex-wrap justify-center gap-4">
                <button id="homeButton" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-100 transition flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Home
                </button>
                <button id="validatorAuthButton" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-100 transition flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Validator Login
                </button>
                <button id="challengeGameButton" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-100 transition flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                    </svg>
                    Linguini Challenge
                </button>
                <button id="searchButton" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-100 transition flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Search
                </button>
                <button id="learnHebrewButton" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-100 transition flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13.4M3.344 11.516l-.008.008A9.752 9.752 0 0012 21.75a9.753 9.753 0 008.657-4.929l-.008-.008-1.339-2.679m0 0l-.952-1.904A2.25 2.25 0 0015.688 9.442l4.474-4.474A9.753 9.753 0 0012 2.25c-2.895 0-5.689 1.173-7.776 3.26l-.008.008z"/>
                    </svg>
                    Learn Hebrew
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <div id="messageBoxContainer"></div>

        <!-- Home View -->
        <div id="homeView" class="view">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center text-5c4b5c">Welcome to Linguini!</h2>
                <p class="text-lg text-center mb-6">Your go-to resource for Technion course terms, translated into multiple languages.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="showAddCourseFormBtn" class="w-full sm:w-auto">Add New Course</button>
                </div>
            </div>

            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 text-5c4b5c">Available Courses</h2>
                <div id="courseList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
        </div>

        <!-- Search View -->
        <div id="searchView" class="view hidden">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 text-5c4b5c">Global Term Search</h2>
                <div class="relative w-full mb-6">
                    <input type="text" id="globalSearchInput" placeholder="Search all terms..." class="pr-10">
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="searchResultsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                <p id="noSearchResultsMessage" class="text-gray-500 text-center mt-4 hidden">No terms found matching your search.</p>
                <button id="clearSearchBtn" class="btn-secondary mt-6">Clear Search</button>
            </div>
        </div>

        <!-- Add Course View -->
        <div id="addCourseView" class="view hidden">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-6 text-5c4b5c">Add New Course</h2>
                <form id="addCourseForm" class="space-y-4">
                    <div>
                        <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                        <input type="text" id="courseName" placeholder="e.g., Calculus 1" required>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit">Add Course</button>
                        <button type="button" id="cancelAddCourseBtn" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Course Details View -->
        <div id="courseDetailsView" class="view hidden">
            <div class="card">
                <h2 id="courseDetailsTitle" class="text-2xl font-semibold mb-4 text-5c4b5c"></h2>
                <p class="text-gray-600 mb-6">Terms for this course:</p>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button id="showAddTermFormBtn" class="w-full sm:w-auto">Add New Term to Course</button>
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="courseSearchInput" placeholder="Search terms in this course..." class="pr-10">
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                <div id="termList" class="grid grid-cols-1 gap-4">
                    </div>
                <p id="noTermsMessage" class="text-gray-500 text-center mt-4 hidden">No terms found for this course. Be the first to add one!</p>
            </div>
        </div>

        <!-- Add Term View -->
        <div id="addTermView" class="view hidden">
            <div class="card">
                <h2 id="addTermFormTitle" class="text-2xl font-semibold mb-6 text-5c4b5c">Add New Term</h2>
                <form id="addTermForm" class="space-y-4">
                    <div>
                        <label for="termHebrew" class="block text-sm font-medium text-gray-700 mb-1">Term (Hebrew) <span class="text-red-500">*</span></label>
                        <input type="text" id="termHebrew" dir="rtl" placeholder="נגזרת" required>
                    </div>
                    <div>
                        <label for="termDefinition" class="block text-sm font-medium text-gray-700 mb-1">Definition <span class="text-red-500">*</span></label>
                        <textarea id="termDefinition" rows="3" placeholder="Provide a clear definition..." required></textarea>
                    </div>
                    <p class="text-sm text-gray-600">Provide translations in other languages (optional):</p>
                    <div>
                        <label for="termEnglish" class="block text-sm font-medium text-gray-700 mb-1">Term (English)</label>
                        <input type="text" id="termEnglish" placeholder="e.g., Derivative">
                    </div>
                    <div>
                        <label for="termRussian" class="block text-sm font-medium text-gray-700 mb-1">Term (Russian)</label>
                        <input type="text" id="termRussian" placeholder="Произודנה">
                    </div>
                    <div>
                        <label for="termArabic" class="block text-sm font-medium text-gray-700 mb-1">Term (Arabic)</label>
                        <input type="text" id="termArabic" dir="rtl" placeholder="مشتقة">
                    </div>
                    <div>
                        <label for="termFrench" class="block text-sm font-medium text-gray-700 mb-1">Term (French)</label>
                        <input type="text" id="termFrench" placeholder="Dérivée">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" id="addTermSubmitBtn">Add Term</button>
                        <button type="button" id="cancelAddTermBtn" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Linguini Challenge Game View -->
        <div id="challengeGameView" class="view hidden">
            <div class="card text-center">
                <h2 class="text-3xl font-bold mb-6 text-5c4b5c">Linguini Challenge!</h2>
                <div id="challengeGameStartScreen">
                    <p class="text-lg mb-4">Choose your native language to start the game:</p>
                    <select id="challengeGameLanguageSelect" class="mb-6 px-4 py-2 rounded-md border border-gray-300">
                        <!-- Options populated by JS -->
                    </select>
                    <button id="startChallengeGameButton">Start Game</button>
                </div>

                <div id="challengeGamePlayScreen" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-2xl font-semibold text-5c4b5c">Score: <span id="challengeGameScore">0</span></div>
                        <div class="text-2xl font-semibold text-red-500">Time: <span id="challengeGameTimer">30</span>s</div>
                    </div>
                    <p class="text-4xl font-bold mb-8 text-5c4b5c" id="challengeGameTermDisplay"></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="challenge-option-button" id="challengeOption1"></button>
                        <button class="challenge-option-button" id="challengeOption2"></button>
                    </div>
                    <p id="challengeGameFeedback" class="text-xl font-semibold mt-6 h-8"></p>
                </div>

                <div id="challengeGameOverScreen" class="hidden">
                    <h3 class="text-3xl font-bold text-5c4b5c mb-4">Game Over!</h3>
                    <p class="text-xl mb-6">Your final score: <span id="challengeFinalScore" class="font-bold text-emerald-600"></span></p>
                    <button id="playAgainChallengeButton">Play Again</button>
                </div>
            </div>
        </div>

        <!-- Learn Hebrew View -->
        <div id="learnHebrewView" class="view hidden">
            <div class="card text-center">
                <h2 class="text-3xl font-bold mb-6 text-5c4b5c">Learn Hebrew Vocabulary</h2>
                <p class="text-lg mb-6">
                    This section helps you master essential Hebrew terms for your academic studies at Technion.
                    Select your native language, and we'll guide you through key vocabulary with interactive games.
                </p>

                <div id="learnHebrewStartScreen">
                    <p class="text-lg mb-4">Choose your native language for learning:</p>
                    <select id="learnHebrewLanguageSelect" class="mb-6 px-4 py-2 rounded-md border border-gray-300">
                        <!-- Options populated by JS -->
                    </select>
                    <button id="startLearningButton">Start Learning</button>
                </div>

                <div id="learnHebrewPlayScreen" class="hidden">
                    <div class="flex justify-between items-center w-full mb-4">
                        <div class="text-xl font-semibold text-5c4b5c">Words Mastered: <span id="masteredWordsCount">0</span></div>
                        <div class="text-xl font-semibold text-5c4b5c">Progress: <span id="learningProgress">0/0</span></div>
                    </div>
                    <div class="flex flex-col items-center mb-6">
                        <p class="text-5xl font-bold text-5c4b5c mb-2" id="hebrewTermDisplay" dir="rtl"></p>
                        <p class="text-xl text-gray-600" id="pronunciationDisplay"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="learn-hebrew-option-button" id="learnHebrewOption1"></button>
                        <button class="learn-hebrew-option-button" id="learnHebrewOption2"></button>
                    </div>
                    <p id="learnHebrewFeedback" class="text-xl font-semibold mt-6 h-8"></p>
                    <button id="learnHebrewNextWordButton" class="btn-secondary mt-4 hidden">Next Word</button>
                </div>

                <div id="learnHebrewEndScreen" class="hidden">
                    <h3 class="text-3xl font-bold text-5c4b5c mb-4">Learning Session Complete!</h3>
                    <p class="text-xl mb-6">You mastered <span id="finalMasteredCount" class="font-bold text-emerald-600"></span> words.</p>
                    <button id="startNewLearningSessionButton">Start New Session</button>
                </div>
            </div>
        </div>
    </main>

    <div class="container flex justify-between items-center py-4 px-6">
        <img src="https://raw.githubusercontent.com/Ethantication/Linguini/main/proxy-image.png" alt="Left Logo" class="h-20 w-auto">
        <img src="https://raw.githubusercontent.com/Ethantication/Linguini/main/LOGO_WIDE_Heb.png" alt="Right Logo" class="h-20 w-auto">
    </div>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm">
        <div class="container flex items-center justify-center">
            &copy; 2025 Linguini. All rights reserved.
            <img src="https://raw.githubusercontent.com/Ethantication/Linguini/main/WhatsApp%20Image%202025-05-19%20at%2019.42.36_a4a2cf4b.jpg" alt="Mascot" class="h-8 w-8 ml-2 rounded-full">
        </div>
    </footer>

    <script>
        // --- Data Storage and Management ---
        const STORAGE_KEY = 'linguiniDataV2';
        const VALIDATOR_SECRET_KEY = 'V2025'; // Updated validator key

        // Function to load data from localStorage
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { courses: [], terms: [] };
        }

        // Function to save data to localStorage
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        let appData = loadData();
        let currentCourseId = null; // Tracks the currently viewed course
        let currentTermId = null;   // Tracks the term being edited (null for new term)
        let isValidatorMode = false; // New state variable for validator mode

        // Define the languages for iteration - Hebrew is the primary display language
        const LANGUAGES = [
            { key: 'hebrew', name: 'Hebrew', dir: 'rtl', inputId: 'termHebrew' },
            { key: 'english', name: 'English', dir: 'ltr', inputId: 'termEnglish' },
            { key: 'russian', name: 'Russian', dir: 'ltr', inputId: 'termRussian' },
            { key: 'arabic', name: 'Arabic', dir: 'rtl', inputId: 'termArabic' },
            { key: 'french', name: 'French', dir: 'ltr', inputId: 'termFrench' }
        ];

        // --- UI Elements ---
        const homeView = document.getElementById('homeView');
        const searchView = document.getElementById('searchView'); // New search view
        const addCourseView = document.getElementById('addCourseView');
        const courseDetailsView = document.getElementById('courseDetailsView');
        const addTermView = document.getElementById('addTermView');
        const challengeGameView = document.getElementById('challengeGameView'); // Renamed game view
        const learnHebrewView = document.getElementById('learnHebrewView'); // New learn Hebrew view
        const messageBoxContainer = document.getElementById('messageBoxContainer');

        const homeButton = document.getElementById('homeButton');
        const validatorAuthButton = document.getElementById('validatorAuthButton');
        const challengeGameButton = document.getElementById('challengeGameButton'); // Renamed button
        const searchButton = document.getElementById('searchButton'); // New search button
        const learnHebrewButton = document.getElementById('learnHebrewButton'); // New learn Hebrew button
        const showAddCourseFormBtn = document.getElementById('showAddCourseFormBtn');
        const addCourseForm = document.getElementById('addCourseForm');
        const cancelAddCourseBtn = document.getElementById('cancelAddCourseBtn');
        const courseList = document.getElementById('courseList');
        const courseDetailsTitle = document.getElementById('courseDetailsTitle');
        const showAddTermFormBtn = document.getElementById('showAddTermFormBtn');
        const addTermForm = document.getElementById('addTermForm');
        const addTermFormTitle = document.getElementById('addTermFormTitle');
        const addTermSubmitBtn = document.getElementById('addTermSubmitBtn');
        const cancelAddTermBtn = document.getElementById('cancelAddTermBtn');
        const termList = document.getElementById('termList');
        const noTermsMessage = document.getElementById('noTermsMessage');
        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResultsList = document.getElementById('searchResultsList');
        const noSearchResultsMessage = document.getElementById('noSearchResultsMessage'); // New message for search
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const courseSearchInput = document.getElementById('courseSearchInput');

        // Linguini Challenge Game UI Elements
        const challengeGameStartScreen = document.getElementById('challengeGameStartScreen');
        const challengeGameLanguageSelect = document.getElementById('challengeGameLanguageSelect');
        const startChallengeGameButton = document.getElementById('startChallengeGameButton');
        const challengeGamePlayScreen = document.getElementById('challengeGamePlayScreen');
        const challengeGameScoreDisplay = document.getElementById('challengeGameScore');
        const challengeGameTimerDisplay = document.getElementById('challengeGameTimer');
        const challengeGameTermDisplay = document.getElementById('challengeGameTermDisplay');
        const challengeOption1Button = document.getElementById('challengeOption1');
        const challengeOption2Button = document.getElementById('challengeOption2');
        const challengeGameFeedbackDisplay = document.getElementById('challengeGameFeedback');
        const challengeGameOverScreen = document.getElementById('challengeGameOverScreen');
        const challengeFinalScoreDisplay = document.getElementById('challengeFinalScore');
        const playAgainChallengeButton = document.getElementById('playAgainChallengeButton');

        // Linguini Challenge Game State Variables
        let challengeGameScore = 0;
        let challengeGameTimeLeft = 30;
        let challengeGameTimerInterval;
        let challengeGameCurrentTerm = null;
        let challengeGameCorrectOptionKey = null;
        let challengeGameSelectedLanguage = null;

        // Learn Hebrew Game UI Elements
        const learnHebrewStartScreen = document.getElementById('learnHebrewStartScreen');
        const learnHebrewLanguageSelect = document.getElementById('learnHebrewLanguageSelect');
        const startLearningButton = document.getElementById('startLearningButton');
        const learnHebrewPlayScreen = document.getElementById('learnHebrewPlayScreen');
        const hebrewTermDisplay = document.getElementById('hebrewTermDisplay');
        const pronunciationDisplay = document.getElementById('pronunciationDisplay'); // New pronunciation display
        const learnHebrewOption1Button = document.getElementById('learnHebrewOption1'); // New option buttons
        const learnHebrewOption2Button = document.getElementById('learnHebrewOption2');
        const learnHebrewFeedbackDisplay = document.getElementById('learnHebrewFeedback'); // New feedback display
        const learnHebrewNextWordButton = document.getElementById('learnHebrewNextWordButton'); // New next word button
        const masteredWordsCountDisplay = document.getElementById('masteredWordsCount');
        const learningProgressDisplay = document.getElementById('learningProgress');
        const learnHebrewEndScreen = document.getElementById('learnHebrewEndScreen');
        const finalMasteredCountDisplay = document.getElementById('finalMasteredCount');
        const startNewLearningSessionButton = document.getElementById('startNewLearningSessionButton');

        // Learn Hebrew Game State Variables
        let learnHebrewSelectedLanguage = null;
        let learningTerms = []; // Terms for the current learning session
        let currentLearningIndex = 0;
        let masteredWordsCount = 0;

        // Tone.js Synths for sound effects
        const correctSynth = new Tone.Synth().toDestination();
        const incorrectSynth = new Tone.Synth().toDestination();
        const gameOverSynth = new Tone.MembraneSynth().toDestination();
        const flipSynth = new Tone.PolySynth().toDestination();

        // --- Learn Hebrew Game Vocabulary (Pre-filled, fixed database) ---
        const learnHebrewVocabulary = [
            {
                hebrew: 'גם',
                pronunciation: 'gam',
                english: 'also',
                russian: 'тоже',
                arabic: 'أيضا',
                french: 'aussi'
            },
            {
                hebrew: 'אולי',
                pronunciation: 'ulay',
                english: 'maybe',
                russian: 'может быть',
                arabic: 'ربما',
                french: 'peut-être'
            },
            {
                hebrew: 'ייתכן',
                pronunciation: 'yitachen',
                english: 'possible',
                russian: 'возможно',
                arabic: 'ممكن',
                french: 'possible'
            },
            {
                hebrew: 'להוכיח',
                pronunciation: 'lehochiach',
                english: 'to prove',
                russian: 'доказать',
                arabic: 'لإثبات',
                french: 'prouver'
            },
            {
                hebrew: 'מצא',
                pronunciation: 'matza',
                english: 'found (he/it)',
                russian: 'нашел',
                arabic: 'وجد',
                french: 'trouvé'
            },
            {
                hebrew: 'כאשר',
                pronunciation: 'kaasher',
                english: 'when (as)',
                russian: 'когда',
                arabic: 'عندما',
                french: 'lorsque'
            },
            {
                hebrew: 'לכן',
                pronunciation: 'lakhen',
                english: 'therefore',
                russian: 'поэтому',
                arabic: 'لذلك',
                french: 'donc'
            },
            {
                hebrew: 'בנוסף',
                pronunciation: 'benosaf',
                english: 'in addition',
                russian: 'кроме того',
                arabic: 'بالإضافة إلى ذلك',
                french: 'en plus'
            },
            {
                hebrew: 'בדרך כלל',
                pronunciation: 'bederech klal',
                english: 'usually',
                russian: 'обычно',
                arabic: 'عادة',
                french: 'habituellement'
            },
            {
                hebrew: 'חשוב',
                pronunciation: 'hashuv',
                english: 'important',
                russian: 'важный',
                arabic: 'مهم',
                french: 'important'
            },
            {
                hebrew: 'פתרון',
                pronunciation: 'pitaron',
                english: 'solution',
                russian: 'решение',
                arabic: 'حل',
                french: 'solution'
            },
            {
                hebrew: 'קבוע',
                pronunciation: 'kavua',
                english: 'constant',
                russian: 'постоянный',
                arabic: 'ثابت',
                french: 'constant'
            },
            {
                hebrew: 'פונקציה',
                pronunciation: 'funktsia',
                english: 'function',
                russian: 'функция',
                arabic: 'دالة',
                french: 'fonction'
            },
            {
                hebrew: 'משוואה',
                pronunciation: 'mishvaah',
                english: 'equation',
                russian: 'уравнение',
                arabic: 'معادلة',
                french: 'équation'
            },
            {
                hebrew: 'מערכת',
                pronunciation: 'maarechet',
                english: 'system',
                russian: 'система',
                arabic: 'نظام',
                french: 'système'
            }
        ];


        // --- Utility Functions ---

        // Function to show a custom message box
        function showMessageBox(message, type = 'info', callback = null) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'messageBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <button id="messageBoxOkBtn" class="px-6 py-2 rounded-md bg-emerald-500 text-white hover:bg-emerald-600 transition">OK</button>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('messageBoxOkBtn').onclick = () => {
                messageBoxContainer.innerHTML = ''; // Clear message box
                if (callback) callback();
            };
        }

        // Function to show a custom confirmation box
        function showConfirmBox(message, onConfirm, onCancel) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'confirmBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmBoxYesBtn" class="px-6 py-2 rounded-md bg-emerald-500 text-white hover:bg-emerald-600 transition">Yes</button>
                    <button id="confirmBoxNoBtn" class="px-6 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition">No</button>
                </div>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('confirmBoxYesBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
                onConfirm();
            };
            document.getElementById('confirmBoxNoBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
                if (onCancel) onCancel();
            };
        }

        // Function to show a custom prompt box
        function showPromptBox(message, onConfirm) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'promptBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <input type="password" id="promptInput" class="mb-4" placeholder="Enter secret key">
                <div class="flex justify-center gap-4">
                    <button id="promptBoxOkBtn" class="px-6 py-2 rounded-md bg-emerald-500 text-white hover:bg-emerald-600 transition">OK</button>
                    <button id="promptBoxCancelBtn" class="px-6 py-2 rounded-md bg-gray-500 text-white hover:bg-gray-600 transition">Cancel</button>
                </div>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('promptBoxOkBtn').onclick = () => {
                const inputValue = document.getElementById('promptInput').value;
                messageBoxContainer.innerHTML = '';
                onConfirm(inputValue);
            };
            document.getElementById('promptBoxCancelBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
            };
        }


        // Function to switch views
        function showView(viewElement) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            viewElement.classList.remove('hidden');
        }

        // Generate a simple unique ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Determines the overall status of a term based on its language statuses
        function getOverallTermStatus(term) {
            let providedLanguages = 0;
            let validatedLanguages = 0;

            LANGUAGES.forEach(lang => {
                if (term[lang.key] && term[lang.key].text) {
                    providedLanguages++;
                    if (term[lang.key].status === 'Validated') {
                        validatedLanguages++;
                    }
                }
            });

            if (providedLanguages === 0) {
                return 'No Content'; // Should not happen if Hebrew is required
            } else if (validatedLanguages === providedLanguages) {
                return 'Fully Validated';
            } else if (validatedLanguages > 0) {
                return 'Partially Validated';
            } else {
                return 'Pending';
            }
        }

        // Get a random element from an array
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Render Functions ---

        // Renders the list of courses
        function renderCourses() {
            courseList.innerHTML = '';
            if (appData.courses.length === 0) {
                courseList.innerHTML = '<p class="text-gray-500 text-center col-span-full">No courses added yet. Be the first!</p>';
                return;
            }
            appData.courses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'card cursor-pointer hover:bg-blue-50 transition flex justify-between items-center';
                courseCard.innerHTML = `
                    <h3 class="text-xl font-semibold text-5c4b5c">${course.name}</h3>
                    <div class="flex gap-2">
                        ${isValidatorMode ? `<button class="btn-delete px-3 py-1 text-sm" data-course-id="${course.id}">Delete</button>` : ''}
                    </div>
                `;
                courseCard.querySelector('h3').onclick = () => viewCourseDetails(course.id);
                // Only attach delete event listener if the button exists
                const deleteBtn = courseCard.querySelector('.btn-delete');
                if (deleteBtn) {
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // Prevent card click
                        deleteCourse(course.id);
                    };
                }
                courseList.appendChild(courseCard);
            });
        }

        // Renders the list of terms for a specific course
        function renderTerms(courseId, searchTerm = '') {
            termList.innerHTML = '';
            const termsForCourse = appData.terms.filter(term => term.courseId === courseId);
            const filteredTerms = searchTerm
                ? termsForCourse.filter(term =>
                    // Search across all language texts and definition
                    LANGUAGES.some(lang =>
                        term[lang.key] && term[lang.key].text && term[lang.key].text.toLowerCase().includes(searchTerm.toLowerCase())
                    ) || term.definition.toLowerCase().includes(searchTerm.toLowerCase())
                )
                : termsForCourse;

            if (filteredTerms.length === 0) {
                noTermsMessage.classList.remove('hidden');
                return;
            } else {
                noTermsMessage.classList.add('hidden');
            }

            filteredTerms.forEach(term => {
                const termOverallStatus = getOverallTermStatus(term);
                let overallStatusClass = '';
                if (termOverallStatus === 'Fully Validated') {
                    overallStatusClass = 'status-overall-fully-validated';
                } else if (termOverallStatus === 'Partially Validated') {
                    overallStatusClass = 'status-overall-partially-validated';
                } else {
                    overallStatusClass = 'status-overall-pending';
                }

                // Display the Hebrew term as the main heading
                const mainTermDisplay = term.hebrew && term.hebrew.text ? term.hebrew.text : (term.english && term.english.text ? term.english.text : 'Untitled Term');

                const termCard = document.createElement('div');
                termCard.className = 'card';
                termCard.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2" dir="rtl">${mainTermDisplay}</h3>
                    <p class="text-gray-700 mb-4">${term.definition}</p>

                    <table class="term-table mb-4">
                        <thead>
                            <tr>
                                <th>Language</th>
                                <th>Translation</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${LANGUAGES.map(lang => {
                                const termLang = term[lang.key];
                                const hasText = termLang && termLang.text;
                                const status = hasText ? termLang.status : 'Not Provided';
                                const statusClass = hasText
                                    ? (status === 'Validated' ? 'status-validated' : 'status-pending')
                                    : 'status-not-provided';
                                const translationText = hasText ? termLang.text : 'N/A';
                                const dirAttribute = lang.dir === 'rtl' ? 'dir="rtl"' : '';

                                return `
                                    <tr>
                                        <td>${lang.name}</td>
                                        <td ${dirAttribute}>${translationText}</td>
                                        <td class="${statusClass}">${status}</td>
                                        <td>
                                            ${isValidatorMode && hasText && status === 'Pending' ?
                                                `<button class="btn-validate px-3 py-1 text-xs" data-term-id="${term.id}" data-lang-key="${lang.key}">Validate</button>` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="flex justify-between items-center mt-4">
                        <span class="text-sm ${overallStatusClass}">
                            Overall Status: ${termOverallStatus}
                        </span>
                        <div class="flex gap-2">
                            <button class="btn-edit px-3 py-1 text-sm" data-term-id="${term.id}">Edit</button>
                            <button class="btn-delete px-3 py-1 text-sm" data-term-id="${term.id}">Delete Term</button>
                        </div>
                    </div>
                `;
                termList.appendChild(termCard);

                // Add event listeners for validate buttons
                termCard.querySelectorAll('.btn-validate').forEach(button => {
                    button.onclick = () => {
                        const termId = button.dataset.termId;
                        const langKey = button.dataset.langKey;
                        validateTerm(termId, langKey);
                    };
                });

                // Add event listener for edit button
                termCard.querySelector('.btn-edit').onclick = () => editTerm(term.id);

                // Add event listener for delete button
                termCard.querySelector('.btn-delete').onclick = () => deleteTerm(term.id);
            });
        }

        // Renders search results
        function renderSearchResults(results) {
            searchResultsList.innerHTML = '';
            if (results.length === 0) {
                noSearchResultsMessage.classList.remove('hidden');
                return;
            } else {
                noSearchResultsMessage.classList.add('hidden');
            }
            results.forEach(term => {
                const termOverallStatus = getOverallTermStatus(term);
                let overallStatusClass = '';
                if (termOverallStatus === 'Fully Validated') {
                    overallStatusClass = 'status-overall-fully-validated';
                } else if (termOverallStatus === 'Partially Validated') {
                    overallStatusClass = 'status-overall-partially-validated';
                } else {
                    overallStatusClass = 'status-overall-pending';
                }

                // Display the Hebrew term as the main heading in search results
                const mainTermDisplay = term.hebrew && term.hebrew.text ? term.hebrew.text : (term.english && term.english.text ? term.english.text : 'Untitled Term');

                const termCard = document.createElement('div');
                termCard.className = 'card';
                termCard.innerHTML = `
                    <h3 class="text-lg font-semibold mb-1" dir="rtl">${mainTermDisplay}</h3>
                    <p class="text-gray-600 text-sm mb-2">${term.definition.substring(0, 100)}${term.definition.length > 100 ? '...' : ''}</p>
                    <p class="text-xs text-gray-500">Course: ${appData.courses.find(c => c.id === term.courseId)?.name || 'Unknown'}</p>
                    <span class="text-xs ${overallStatusClass}">
                        Overall Status: ${termOverallStatus}
                    </span>
                `;
                searchResultsList.appendChild(termCard);
            });
        }

        // --- Event Handlers ---

        // Handle validator login/logout
        validatorAuthButton.onclick = () => {
            if (isValidatorMode) {
                // Logout
                isValidatorMode = false;
                validatorAuthButton.textContent = 'Validator Login';
                showMessageBox('Logged out of Validator Mode.', 'info', renderCourses); // Re-render to hide buttons
            } else {
                // Login
                showPromptBox('Enter validator secret key:', (key) => {
                    if (key === VALIDATOR_SECRET_KEY) {
                        isValidatorMode = true;
                        validatorAuthButton.textContent = 'Validator Logout';
                        showMessageBox('Successfully logged into Validator Mode!', 'success', renderCourses); // Re-render to show buttons
                    } else {
                        showMessageBox('Invalid secret key. Access denied.', 'error');
                    }
                });
            }
        };


        // Handle adding a new course
        addCourseForm.onsubmit = (e) => {
            e.preventDefault();
            const courseName = document.getElementById('courseName').value.trim();
            if (courseName) {
                const newCourse = {
                    id: generateId(),
                    name: courseName
                };
                appData.courses.push(newCourse);
                saveData(appData);
                showMessageBox('Course added successfully!', 'success', () => {
                    addCourseForm.reset();
                    showView(homeView);
                    renderCourses();
                });
            } else {
                showMessageBox('Course name cannot be empty.', 'error');
            }
        };

        // Handle adding or editing a term
        addTermForm.onsubmit = (e) => {
            e.preventDefault();
            const termHebrew = document.getElementById('termHebrew').value.trim();
            const termDefinition = document.getElementById('termDefinition').value.trim();

            if (!termHebrew || !termDefinition || !currentCourseId) {
                showMessageBox('Hebrew term and definition are required.', 'error');
                return;
            }

            let termToUpdate = null;
            let termIndex = -1;

            if (currentTermId) { // Editing an existing term
                termIndex = appData.terms.findIndex(t => t.id === currentTermId);
                if (termIndex !== -1) {
                    termToUpdate = appData.terms[termIndex];
                }
            }

            if (!termToUpdate) { // Adding a new term
                termToUpdate = {
                    id: generateId(),
                    courseId: currentCourseId,
                };
                appData.terms.push(termToUpdate);
            }

            termToUpdate.definition = termDefinition;

            // Process all language fields
            LANGUAGES.forEach(lang => {
                const inputElement = document.getElementById(lang.inputId);
                const newText = inputElement ? inputElement.value.trim() : ''; // Get current input value

                const oldLangData = termToUpdate[lang.key];
                const oldText = oldLangData ? oldLangData.text : '';

                if (newText) { // If new text is provided
                    if (!oldLangData || newText !== oldText) {
                        // If it's a new translation or the text has changed, reset status to Pending
                        termToUpdate[lang.key] = {
                            text: newText,
                            status: 'Pending',
                            validatedBy: null
                        };
                    } else {
                        // If text is provided and hasn't changed, keep existing status
                        termToUpdate[lang.key] = {
                            text: newText,
                            status: oldLangData.status,
                            validatedBy: oldLangData.validatedBy
                        };
                    }
                } else { // If new text is empty (translation removed or not provided)
                    termToUpdate[lang.key] = null;
                }
            });

            saveData(appData);
            showMessageBox(currentTermId ? 'Term updated successfully!' : 'Term added successfully! Individual translations are pending validation.', 'success', () => {
                addTermForm.reset();
                currentTermId = null; // Clear editing state
                viewCourseDetails(currentCourseId); // Go back to course details
            });
        };

        // Function to prepare the form for editing a term
        function editTerm(termId) {
            currentTermId = termId;
            const term = appData.terms.find(t => t.id === termId);

            if (term) {
                addTermFormTitle.textContent = 'Edit Term';
                addTermSubmitBtn.textContent = 'Save Changes';

                document.getElementById('termDefinition').value = term.definition;

                LANGUAGES.forEach(lang => {
                    const inputElement = document.getElementById(lang.inputId);
                    if (inputElement) {
                        inputElement.value = term[lang.key] && term[lang.key].text ? term[lang.key].text : '';
                    }
                });

                showView(addTermView);
            } else {
                showMessageBox('Term not found for editing.', 'error');
                currentTermId = null; // Reset if term not found
            }
        }


        // Validate a term for a specific language using the secret key
        function validateTerm(termId, langKey) {
            showPromptBox(`Enter validator secret key for ${langKey} translation:`, (key) => {
                if (key === VALIDATOR_SECRET_KEY) {
                    const termIndex = appData.terms.findIndex(t => t.id === termId);
                    if (termIndex !== -1 && appData.terms[termIndex][langKey]) {
                        appData.terms[termIndex][langKey].status = 'Validated';
                        appData.terms[termIndex][langKey].validatedBy = 'Validator'; // Placeholder for validator ID
                        saveData(appData);
                        showMessageBox(`${langKey} translation validated successfully!`, 'success', () => {
                            renderTerms(currentCourseId); // Re-render terms for current course
                        });
                    } else {
                        showMessageBox(`Could not validate ${langKey} translation.`, 'error');
                    }
                } else {
                    showMessageBox('Invalid secret key. Translation not validated.', 'error');
                }
            });
        }

        // Delete a course
        function deleteCourse(courseId) {
            showConfirmBox('Are you sure you want to delete this course and all its terms?', () => {
                appData.courses = appData.courses.filter(c => c.id !== courseId);
                appData.terms = appData.terms.filter(t => t.courseId !== courseId); // Also delete associated terms
                saveData(appData);
                showMessageBox('Course and associated terms deleted.', 'info', () => {
                    renderCourses();
                    if (currentCourseId === courseId) {
                        currentCourseId = null; // Clear current course if deleted
                        showView(homeView);
                    }
                });
            });
        }

        // Delete a term
        function deleteTerm(termId) {
            showConfirmBox('Are you sure you want to delete this term?', () => {
                appData.terms = appData.terms.filter(t => t.id !== term);
                saveData(appData);
                showMessageBox('Term deleted.', 'info', () => {
                    renderTerms(currentCourseId); // Re-render terms for current course
                });
            });
        }

        // Global search functionality
        globalSearchInput.onkeyup = () => {
            const query = globalSearchInput.value.trim().toLowerCase();
            if (query.length > 0) {
                const results = appData.terms.filter(term =>
                    // Search across all language texts and definition
                    LANGUAGES.some(lang =>
                        term[lang.key] && term[lang.key].text && term[lang.key].text.toLowerCase().includes(query)
                    ) || term.definition.toLowerCase().includes(query)
                );
                renderSearchResults(results);
            } else {
                searchResultsList.innerHTML = '';
                noSearchResultsMessage.classList.remove('hidden');
            }
        };

        // Clear global search results
        clearSearchBtn.onclick = () => {
            globalSearchInput.value = '';
            searchResultsList.innerHTML = '';
            noSearchResultsMessage.classList.remove('hidden');
        };

        // Course-specific search functionality
        courseSearchInput.onkeyup = () => {
            renderTerms(currentCourseId, courseSearchInput.value.trim());
        };


        // --- Linguini Challenge Game Logic ---

        // Populate language selection dropdown for the challenge game
        function populateChallengeGameLanguageSelect() {
            challengeGameLanguageSelect.innerHTML = '';
            // Add a default "select" option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select your native language';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            challengeGameLanguageSelect.appendChild(defaultOption);

            LANGUAGES.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.key;
                option.textContent = lang.name;
                challengeGameLanguageSelect.appendChild(option);
            });
        }

        // Start the challenge game
        startChallengeGameButton.onclick = async () => {
            // Initialize Tone.js context if not already running (required for sounds)
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            challengeGameSelectedLanguage = challengeGameLanguageSelect.value;
            if (!challengeGameSelectedLanguage) {
                showMessageBox('Please select your native language to start the game.', 'error');
                return;
            }

            // Filter terms to only include those that have a translation in the selected native language
            // and have at least one other language translation to be the source term.
            const playableTerms = appData.terms.filter(term => {
                const hasNativeTranslation = term[challengeGameSelectedLanguage] && term[challengeGameSelectedLanguage].text;
                const hasOtherLanguageTranslation = LANGUAGES.some(lang =>
                    lang.key !== challengeGameSelectedLanguage && term[lang.key] && term[lang.key].text
                );
                return hasNativeTranslation && hasOtherLanguageTranslation;
            });

            if (playableTerms.length < 2) { // Need at least two terms to generate a question with a distractor
                showMessageBox('Not enough terms with translations in your selected language and another language to play. Please add more terms!', 'error');
                return;
            }

            challengeGameScore = 0;
            challengeGameTimeLeft = 30;
            challengeGameScoreDisplay.textContent = challengeGameScore;
            challengeGameTimerDisplay.textContent = challengeGameTimeLeft;
            challengeGameFeedbackDisplay.textContent = '';

            challengeGameStartScreen.classList.add('hidden');
            challengeGamePlayScreen.classList.remove('hidden');
            challengeGameOverScreen.classList.add('hidden');

            startChallengeTimer();
            generateChallengeQuestion();
        };

        // Challenge Game Timer functionality
        function startChallengeTimer() {
            clearInterval(challengeGameTimerInterval); // Clear any existing timer
            challengeGameTimerInterval = setInterval(() => {
                challengeGameTimeLeft--;
                challengeGameTimerDisplay.textContent = challengeGameTimeLeft;
                if (challengeGameTimeLeft <= 0) {
                    endChallengeGame();
                }
            }, 1000);
        }

        // Generate a new challenge question
        function generateChallengeQuestion() {
            // Reset button styles
            challengeOption1Button.classList.remove('correct', 'incorrect');
            challengeOption2Button.classList.remove('correct', 'incorrect');
            challengeGameFeedbackDisplay.textContent = '';
            challengeOption1Button.disabled = false;
            challengeOption2Button.disabled = false;

            const playableTerms = appData.terms.filter(term => {
                const hasNativeTranslation = term[challengeGameSelectedLanguage] && term[challengeGameSelectedLanguage].text;
                const hasOtherLanguageTranslation = LANGUAGES.some(lang =>
                    lang.key !== challengeGameSelectedLanguage && term[lang.key] && term[lang.key].text
                );
                return hasNativeTranslation && hasOtherLanguageTranslation;
            });

            if (playableTerms.length < 2) {
                endChallengeGame('Game ended: Not enough diverse terms to create questions.');
                return;
            }

            // 1. Pick a random term for the question (the one whose translation will be displayed)
            let randomTerm = getRandomElement(playableTerms);
            challengeGameCurrentTerm = randomTerm;

            // Pick a random source language for the displayed term (not the native language)
            const sourceLang = getRandomElement(LANGUAGES.filter(lang => lang.key !== challengeGameSelectedLanguage && challengeGameCurrentTerm[lang.key] && challengeGameCurrentTerm[lang.key].text));
            if (!sourceLang) {
                // This scenario should be caught by playableTerms filter, but as a safeguard
                endChallengeGame('Game ended: Could not find a source language for the term.');
                return;
            }

            challengeGameTermDisplay.textContent = challengeGameCurrentTerm[sourceLang.key].text;
            challengeGameTermDisplay.dir = sourceLang.dir; // Set text direction

            const correctTranslation = challengeGameCurrentTerm[challengeGameSelectedLanguage].text;

            // 2. Generate an incorrect option (a translation from a *different* term)
            let incorrectTranslation = '';
            let incorrectTerm = null;
            // Loop until we find a term that is different from challengeGameCurrentTerm
            // and has a translation in the selected native language.
            do {
                incorrectTerm = getRandomElement(playableTerms);
            } while (incorrectTerm.id === challengeGameCurrentTerm.id);

            incorrectTranslation = incorrectTerm[challengeGameSelectedLanguage].text;

            // 3. Prepare options and shuffle them
            const options = [
                { text: correctTranslation, isCorrect: true, key: 'challengeOption1' },
                { text: incorrectTranslation, isCorrect: false, key: 'challengeOption2' }
            ];
            shuffleArray(options);

            challengeOption1Button.textContent = options[0].text;
            challengeOption1Button.dir = LANGUAGES.find(l => l.key === challengeGameSelectedLanguage).dir; // Set option text direction
            challengeOption1Button.onclick = () => checkChallengeAnswer(options[0].isCorrect, 'challengeOption1');

            challengeOption2Button.textContent = options[1].text;
            challengeOption2Button.dir = LANGUAGES.find(l => l.key === challengeGameSelectedLanguage).dir; // Set option text direction
            challengeOption2Button.onclick = () => checkChallengeAnswer(options[1].isCorrect, 'challengeOption2');

            challengeGameCorrectOptionKey = options.find(opt => opt.isCorrect).key; // Store which option is correct
        }

        // Check the user's answer for challenge game
        function checkChallengeAnswer(isCorrect, clickedOptionKey) {
            // Disable buttons to prevent multiple clicks
            challengeOption1Button.disabled = true;
            challengeOption2Button.disabled = true;

            const clickedButton = document.getElementById(clickedOptionKey);
            const correctButton = document.getElementById(challengeGameCorrectOptionKey === 'challengeOption1' ? 'challengeOption1' : 'challengeOption2');

            if (isCorrect) {
                challengeGameScore++;
                challengeGameScoreDisplay.textContent = challengeGameScore;
                challengeGameFeedbackDisplay.textContent = 'Correct!';
                challengeGameFeedbackDisplay.classList.remove('text-red-500');
                challengeGameFeedbackDisplay.classList.add('text-emerald-500');
                correctSynth.triggerAttackRelease('C5', '8n'); // Play a note for correct answer
                clickedButton.classList.add('correct');
            } else {
                challengeGameFeedbackDisplay.textContent = 'Incorrect!';
                challengeGameFeedbackDisplay.classList.remove('text-emerald-500');
                challengeGameFeedbackDisplay.classList.add('text-red-500');
                incorrectSynth.triggerAttackRelease('C4', '8n'); // Play a different note for incorrect
                clickedButton.classList.add('incorrect');
                correctButton.classList.add('correct'); // Show the correct answer
            }

            // Wait a moment before generating the next question
            setTimeout(() => {
                if (challengeGameTimeLeft > 0) { // Only generate next if time hasn't run out
                    generateChallengeQuestion();
                }
            }, 1000); // 1 second delay
        }

        // End the challenge game
        function endChallengeGame(message = '') {
            clearInterval(challengeGameTimerInterval);
            gameOverSynth.triggerAttackRelease('C2', '2n'); // Game over sound

            challengeGamePlayScreen.classList.add('hidden');
            challengeGameOverScreen.classList.remove('hidden');
            challengeFinalScoreDisplay.textContent = challengeGameScore;

            if (message) {
                showMessageBox(message, 'info', () => {
                    showView(challengeGameView); // Go back to game start screen
                    challengeGameStartScreen.classList.remove('hidden');
                    challengeGamePlayScreen.classList.add('hidden');
                    challengeGameOverScreen.classList.add('hidden');
                });
            }
        }

        // Play again button for challenge game
        playAgainChallengeButton.onclick = () => {
            challengeGameStartScreen.classList.remove('hidden');
            challengeGamePlayScreen.classList.add('hidden');
            challengeGameOverScreen.classList.add('hidden');
            challengeGameScore = 0;
            challengeGameTimeLeft = 30;
            challengeGameScoreDisplay.textContent = challengeGameScore;
            challengeGameTimerDisplay.textContent = challengeGameTimeLeft;
            challengeGameFeedbackDisplay.textContent = '';
        };


        // --- Learn Hebrew Game Logic ---

        // Populate language selection dropdown for learn Hebrew game
        function populateLearnHebrewLanguageSelect() {
            learnHebrewLanguageSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select your native language';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            learnHebrewLanguageSelect.appendChild(defaultOption);

            LANGUAGES.filter(lang => lang.key !== 'hebrew').forEach(lang => { // Exclude Hebrew as native language for learning Hebrew
                const option = document.createElement('option');
                option.value = lang.key;
                option.textContent = lang.name;
                learnHebrewLanguageSelect.appendChild(option);
            });
        }

        // Start learning session
        startLearningButton.onclick = async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            learnHebrewSelectedLanguage = learnHebrewLanguageSelect.value;
            if (!learnHebrewSelectedLanguage) {
                showMessageBox('Please select your native language to start learning.', 'error');
                return;
            }

            // Filter terms that have both a Hebrew term and a translation in the selected native language
            // Use the dedicated `learnHebrewVocabulary` for this game
            learningTerms = learnHebrewVocabulary.filter(term =>
                term.hebrew && term[learnHebrewSelectedLanguage]
            );

            if (learningTerms.length < 2) { // Need at least two terms to generate a question with a distractor
                showMessageBox('Not enough Hebrew terms with translations in your selected language available for learning. Please add more terms to the vocabulary!', 'error');
                return;
            }

            shuffleArray(learningTerms); // Randomize the order of terms
            currentLearningIndex = 0;
            masteredWordsCount = 0;
            masteredWordsCountDisplay.textContent = masteredWordsCount;

            learnHebrewStartScreen.classList.add('hidden');
            learnHebrewPlayScreen.classList.remove('hidden');
            learnHebrewEndScreen.classList.add('hidden');

            displayNextLearningTerm();
        };

        // Display the next Hebrew term flashcard
        function displayNextLearningTerm() {
            if (currentLearningIndex >= learningTerms.length) {
                endLearningSession();
                return;
            }

            const term = learningTerms[currentLearningIndex];
            hebrewTermDisplay.textContent = term.hebrew;
            pronunciationDisplay.textContent = `(${term.pronunciation})`;
            learnHebrewFeedbackDisplay.textContent = ''; // Clear feedback
            learnHebrewOption1Button.disabled = false; // Enable buttons
            learnHebrewOption2Button.disabled = false;
            learnHebrewOption1Button.classList.remove('correct', 'incorrect'); // Reset button styles
            learnHebrewOption2Button.classList.remove('correct', 'incorrect');
            learnHebrewNextWordButton.classList.add('hidden'); // Hide next button

            const correctTranslation = term[learnHebrewSelectedLanguage];

            // Generate an incorrect option (a translation from a *different* term)
            let incorrectTranslation = '';
            let incorrectTerm = null;
            do {
                incorrectTerm = getRandomElement(learningTerms);
            } while (incorrectTerm === term || !incorrectTerm[learnHebrewSelectedLanguage]); // Ensure different term and has translation

            incorrectTranslation = incorrectTerm[learnHebrewSelectedLanguage];

            // Prepare options and shuffle them
            const options = [
                { text: correctTranslation, isCorrect: true, key: 'learnHebrewOption1' },
                { text: incorrectTranslation, isCorrect: false, key: 'learnHebrewOption2' }
            ];
            shuffleArray(options);

            learnHebrewOption1Button.textContent = options[0].text;
            learnHebrewOption1Button.dir = LANGUAGES.find(l => l.key === learnHebrewSelectedLanguage).dir;
            learnHebrewOption1Button.onclick = () => checkLearnHebrewAnswer(options[0].isCorrect, 'learnHebrewOption1');

            learnHebrewOption2Button.textContent = options[1].text;
            learnHebrewOption2Button.dir = LANGUAGES.find(l => l.key === learnHebrewSelectedLanguage).dir;
            learnHebrewOption2Button.onclick = () => checkLearnHebrewAnswer(options[1].isCorrect, 'learnHebrewOption2');

            // Store which option is correct for feedback
            learnHebrewOption1Button.dataset.isCorrect = options[0].isCorrect;
            learnHebrewOption2Button.dataset.isCorrect = options[1].isCorrect;

            updateLearningProgress();
        }

        // Update learning progress display
        function updateLearningProgress() {
            learningProgressDisplay.textContent = `${currentLearningIndex + 1}/${learningTerms.length}`;
            if (currentLearningIndex >= learningTerms.length) {
                 learningProgressDisplay.textContent = `${learningTerms.length}/${learningTerms.length}`;
            }
        }

        // Check the user's answer for Learn Hebrew game
        function checkLearnHebrewAnswer(isCorrect, clickedOptionId) {
            // Disable buttons to prevent multiple clicks
            learnHebrewOption1Button.disabled = true;
            learnHebrewOption2Button.disabled = true;

            const clickedButton = document.getElementById(clickedOptionId);

            if (isCorrect) {
                masteredWordsCount++;
                masteredWordsCountDisplay.textContent = masteredWordsCount;
                learnHebrewFeedbackDisplay.textContent = 'Correct!';
                learnHebrewFeedbackDisplay.classList.remove('text-red-500');
                learnHebrewFeedbackDisplay.classList.add('text-emerald-500');
                correctSynth.triggerAttackRelease('C5', '8n');
                clickedButton.classList.add('correct');
            } else {
                learnHebrewFeedbackDisplay.textContent = 'Incorrect!';
                learnHebrewFeedbackDisplay.classList.remove('text-emerald-500');
                learnHebrewFeedbackDisplay.classList.add('text-red-500');
                incorrectSynth.triggerAttackRelease('C4', '8n');
                clickedButton.classList.add('incorrect');

                // Show the correct answer
                if (learnHebrewOption1Button.dataset.isCorrect === 'true') {
                    learnHebrewOption1Button.classList.add('correct');
                } else {
                    learnHebrewOption2Button.classList.add('correct');
                }
            }
            learnHebrewNextWordButton.classList.remove('hidden'); // Show next button
        }

        // Move to the next word in Learn Hebrew game
        learnHebrewNextWordButton.onclick = () => {
            currentLearningIndex++;
            displayNextLearningTerm();
        };

        // End learning session
        function endLearningSession() {
            learnHebrewPlayScreen.classList.add('hidden');
            learnHebrewEndScreen.classList.remove('hidden');
            finalMasteredCountDisplay.textContent = masteredWordsCount;
        }

        // Start new learning session
        startNewLearningSessionButton.onclick = () => {
            learnHebrewStartScreen.classList.remove('hidden');
            learnHebrewPlayScreen.classList.add('hidden');
            learnHebrewEndScreen.classList.add('hidden');
            masteredWordsCount = 0;
            currentLearningIndex = 0;
            masteredWordsCountDisplay.textContent = masteredWordsCount;
            learnHebrewLanguageSelect.value = ''; // Reset language selection
        };


        // --- Navigation Logic ---

        // Function to view course details
        function viewCourseDetails(id) {
            currentCourseId = id;
            const course = appData.courses.find(c => c.id === id);
            if (course) {
                courseDetailsTitle.textContent = course.name;
                courseSearchInput.value = ''; // Clear course search when navigating
                renderTerms(id);
                showView(courseDetailsView);
            } else {
                showMessageBox('Course not found.', 'error', () => {
                    showView(homeView);
                    renderCourses();
                });
                currentCourseId = null; // Reset current course ID if not found
            }
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderCourses(); // Initial render to show courses (with or without delete buttons)
            populateChallengeGameLanguageSelect(); // Populate language options for the challenge game
            populateLearnHebrewLanguageSelect(); // Populate language options for the learn Hebrew game
            showView(homeView);
        });

        // Event listeners for navigation buttons
        homeButton.onclick = () => {
            showView(homeView);
            renderCourses();
            // Reset search and game states when returning home
            globalSearchInput.value = '';
            searchResultsList.innerHTML = '';
            noSearchResultsMessage.classList.remove('hidden');
            currentCourseId = null;
            currentTermId = null;
            clearInterval(challengeGameTimerInterval); // Stop challenge game timer
        };
        showAddCourseFormBtn.onclick = () => showView(addCourseView);
        cancelAddCourseBtn.onclick = () => {
            addCourseForm.reset();
            showView(homeView);
        };
        showAddTermFormBtn.onclick = () => {
            // Prepare form for adding a new term
            addTermForm.reset();
            addTermFormTitle.textContent = 'Add New Term';
            addTermSubmitBtn.textContent = 'Add Term';
            currentTermId = null; // Ensure we're in "add new" mode
            showView(addTermView);
        };
        cancelAddTermBtn.onclick = () => {
            addTermForm.reset();
            currentTermId = null; // Clear editing state
            if (currentCourseId) {
                viewCourseDetails(currentCourseId); // Go back to course details if a course was selected
            } else {
                showView(homeView); // Otherwise go to home
            }
        };

        // "Linguini Challenge" button click handler
        challengeGameButton.onclick = () => {
            showView(challengeGameView);
            challengeGameStartScreen.classList.remove('hidden');
            challengeGamePlayScreen.classList.add('hidden');
            challengeGameOverScreen.classList.add('hidden');
            populateChallengeGameLanguageSelect(); // Ensure dropdown is fresh
        };

        // "Search" button click handler
        searchButton.onclick = () => {
            showView(searchView);
            globalSearchInput.value = ''; // Clear search input when entering search view
            searchResultsList.innerHTML = '';
            noSearchResultsMessage.classList.remove('hidden');
        };

        // "Learn Hebrew" button click handler
        learnHebrewButton.onclick = () => {
            showView(learnHebrewView);
            learnHebrewStartScreen.classList.remove('hidden');
            learnHebrewPlayScreen.classList.add('hidden');
            learnHebrewEndScreen.classList.add('hidden');
            populateLearnHebrewLanguageSelect(); // Ensure dropdown is fresh
        };

        // --- Initial Data (for demonstration) ---
        // You can uncomment this to pre-populate some data for testing
        
        if (appData.courses.length === 0 && appData.terms.length === 0) {
            appData = {
                courses: [
                    { id: 'c1', name: 'Calculus 1' },
                    { id: 'c2', name: 'Algebra' },
                    { id: 'c3', name: 'Introduction to Python' },
                    { id: 'c4', name: 'General Biology' },
                    { id: 'c5', name: 'Organic Chemistry' }
                ],
                terms: [
                    {
                        id: 't1', courseId: 'c1', definition: 'The rate at which the value of a function changes with respect to a change in the independent variable.',
                        hebrew: { text: 'נגזרת', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Derivative', status: 'Pending', validatedBy: null },
                        russian: { text: 'Производная', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'مشتقة', status: 'Pending', validatedBy: null },
                        french: { text: 'Dérivée', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't2', courseId: 'c1', definition: 'A mathematical object that can be interpreted as an area, a generalization of mass, or the total change of a quantity whose rate of change is known.',
                        hebrew: { text: 'אינטגרל', status: 'Pending', validatedBy: null },
                        english: { text: 'Integral', status: 'Pending', validatedBy: null },
                        russian: null, // Not provided
                        arabic: { text: 'تكامل', status: 'Pending', validatedBy: null }, // Arabic for 'integral'
                        french: null // Not provided
                    },
                    {
                        id: 't3', courseId: 'c2', definition: 'A rectangular array of numbers, symbols, or expressions, arranged in rows and columns.',
                        hebrew: { text: 'מטריצה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Matrix', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'Матрица', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'מصفوفة', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Matrice', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't4', courseId: 'c3', definition: 'A named storage location that contains a value.',
                        hebrew: { text: 'משתנה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Variable', status: 'Pending', validatedBy: null },
                        russian: { text: 'Переменная', status: 'Pending', validatedBy: null },
                        arabic: null,
                        french: null
                    },
                    {
                        id: 't5', courseId: 'c4', definition: 'The powerhouse of the cell, responsible for cellular respiration.',
                        hebrew: { text: 'מיטוכונדריה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Mitochondria', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'Митохондрии', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'الميتوكوندريا', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Mitochondrie', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't6', courseId: 'c1', definition: 'The process of finding the derivative of a function.',
                        hebrew: { text: 'גזירה', status: 'Pending', validatedBy: null },
                        english: { text: 'Differentiation', status: 'Pending', validatedBy: null },
                        russian: { text: 'Дифференцирование', status: 'Pending', validatedBy: null },
                        arabic: { text: 'التفاضل', status: 'Pending', validatedBy: null },
                        french: { text: 'Différenciation', status: 'Pending', validatedBy: null }
                    },
                    {
                        id: 't7', courseId: 'c3', definition: 'A sequence of characters.',
                        hebrew: { text: 'מחרוזת', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'String', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'Строка', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'سلسلة', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Chaîne', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't8', courseId: 'c5', definition: 'A chemical compound containing carbon, hydrogen, and oxygen, often with a ring structure.',
                        hebrew: { text: 'בנזן', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Benzene', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'Бензол', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'بنزين', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Benzène', status: 'Validated', validatedBy: 'Admin' }
                    }
                ]
            };
            saveData(appData);
        }
        
    </script>
</body>
</html>
