<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linguini - Braking The Language Barrier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"], textarea {
            border: 1px solid #cbd5e1; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background-color: #64748b; /* slate-500 */
        }
        .btn-secondary:hover {
            background-color: #475569; /* slate-600 */
        }
        .btn-validate {
            background-color: #10b981; /* emerald-500 */
        }
        .btn-validate:hover {
            background-color: #059669; /* emerald-600 */
        }
        .btn-edit {
            background-color: #f97316; /* orange-500 */
        }
        .btn-edit:hover {
            background-color: #ea580c; /* orange-600 */
        }
        .btn-delete {
            background-color: #ef4444; /* red-500 */
        }
        .btn-delete:hover {
            background-color: #dc2626; /* red-600 */
        }
        .status-pending {
            color: #f59e0b; /* amber-500 */
            font-weight: 500;
        }
        .status-validated {
            color: #10b981; /* emerald-500 */
            font-weight: 500;
        }
        .status-not-provided {
            color: #94a3b8; /* slate-400 */
            font-style: italic;
        }
        .status-overall-fully-validated {
            color: #059669; /* green-700 */
            font-weight: 600;
        }
        .status-overall-partially-validated {
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .status-overall-pending {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            min-width: 300px;
        }
        .message-box-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Table styling for terms */
        .term-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .term-table th, .term-table td {
            border: 1px solid #e2e8f0; /* gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        .term-table th {
            background-color: #f8fafc; /* gray-50 */
            font-weight: 600;
            color: #475569; /* slate-700 */
        }

        /* Custom header background color */
        .bg-header-custom {
            background-color: #faeddb;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-header-custom text-white p-4 shadow-lg">
        <div class="container flex flex-col items-center">
            <div class="flex justify-center mb-4 sm:mb-0">
                <img src="https://raw.githubusercontent.com/Ethantication/Linguini/main/lingimg.jpg" alt="Linguini Logo" class="h-17 w-17 rounded-full">
            </div>
            <nav class="flex gap-4">
                <button id="homeButton" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-semibold hover:bg-blue-100 transition">Home</button>
                <button id="validatorAuthButton" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-semibold hover:bg-blue-100 transition">Validator Login</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <div id="messageBoxContainer"></div>

        <div id="homeView" class="view">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Welcome to Linguini!</h2>
                <p class="text-lg text-center mb-6">Your go-to resource for Technion course terms, translated into multiple languages.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="showAddCourseFormBtn" class="w-full sm:w-auto">Add New Course</button>
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="globalSearchInput" placeholder="Search all terms..." class="pr-10">
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
            </div>

            <div id="searchResults" class="card hidden">
                <h3 class="text-xl font-semibold mb-4">Search Results</h3>
                <div id="searchResultsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                <button id="clearSearchBtn" class="btn-secondary mt-6">Clear Search</button>
            </div>

            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Available Courses</h2>
                <div id="courseList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
        </div>

        <div id="addCourseView" class="view hidden">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-6">Add New Course</h2>
                <form id="addCourseForm" class="space-y-4">
                    <div>
                        <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                        <input type="text" id="courseName" placeholder="e.g., Calculus 1" required>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit">Add Course</button>
                        <button type="button" id="cancelAddCourseBtn" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="courseDetailsView" class="view hidden">
            <div class="card">
                <h2 id="courseDetailsTitle" class="text-2xl font-semibold mb-4"></h2>
                <p class="text-gray-600 mb-6">Terms for this course:</p>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button id="showAddTermFormBtn" class="w-full sm:w-auto">Add New Term to Course</button>
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="courseSearchInput" placeholder="Search terms in this course..." class="pr-10">
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                <div id="termList" class="grid grid-cols-1 gap-4">
                    </div>
                <p id="noTermsMessage" class="text-gray-500 text-center mt-4 hidden">No terms found for this course. Be the first to add one!</p>
            </div>
        </div>

        <div id="addTermView" class="view hidden">
            <div class="card">
                <h2 id="addTermFormTitle" class="text-2xl font-semibold mb-6">Add New Term</h2>
                <form id="addTermForm" class="space-y-4">
                    <div>
                        <label for="termHebrew" class="block text-sm font-medium text-gray-700 mb-1">Term (Hebrew) <span class="text-red-500">*</span></label>
                        <input type="text" id="termHebrew" dir="rtl" placeholder="נגזרת" required>
                    </div>
                    <div>
                        <label for="termDefinition" class="block text-sm font-medium text-gray-700 mb-1">Definition <span class="text-red-500">*</span></label>
                        <textarea id="termDefinition" rows="3" placeholder="Provide a clear definition..." required></textarea>
                    </div>
                    <p class="text-sm text-gray-600">Provide translations in other languages (optional):</p>
                    <div>
                        <label for="termEnglish" class="block text-sm font-medium text-gray-700 mb-1">Term (English)</label>
                        <input type="text" id="termEnglish" placeholder="e.g., Derivative">
                    </div>
                    <div>
                        <label for="termRussian" class="block text-sm font-medium text-gray-700 mb-1">Term (Russian)</label>
                        <input type="text" id="termRussian" placeholder="Производная">
                    </div>
                    <div>
                        <label for="termArabic" class="block text-sm font-medium text-gray-700 mb-1">Term (Arabic)</label>
                        <input type="text" id="termArabic" dir="rtl" placeholder="مشتقة">
                    </div>
                    <div>
                        <label for="termFrench" class="block text-sm font-medium text-gray-700 mb-1">Term (French)</label>
                        <input type="text" id="termFrench" placeholder="Dérivée">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" id="addTermSubmitBtn">Add Term</button>
                        <button type="button" id="cancelAddTermBtn" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm">
        <div class="container">
            &copy; 2025 Linguini. All rights reserved. Built for Technion students.
        </div>
    </footer>

    <script>
        // --- Data Storage and Management ---
        const STORAGE_KEY = 'linguiniDataV2';
        const VALIDATOR_SECRET_KEY = 'technion_linguini_validator_2025';

        // Function to load data from localStorage
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { courses: [], terms: [] };
        }

        // Function to save data to localStorage
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        let appData = loadData();
        let currentCourseId = null; // Tracks the currently viewed course
        let currentTermId = null;   // Tracks the term being edited (null for new term)
        let isValidatorMode = false; // New state variable for validator mode

        // Define the languages for iteration - Hebrew is the primary display language
        const LANGUAGES = [
            { key: 'hebrew', name: 'Hebrew', dir: 'rtl', inputId: 'termHebrew' },
            { key: 'english', name: 'English', dir: 'ltr', inputId: 'termEnglish' },
            { key: 'russian', name: 'Russian', dir: 'ltr', inputId: 'termRussian' },
            { key: 'arabic', name: 'Arabic', dir: 'rtl', inputId: 'termArabic' },
            { key: 'french', name: 'French', dir: 'ltr', inputId: 'termFrench' }
        ];

        // --- UI Elements ---
        const homeView = document.getElementById('homeView');
        const addCourseView = document.getElementById('addCourseView');
        const courseDetailsView = document.getElementById('courseDetailsView');
        const addTermView = document.getElementById('addTermView');
        const messageBoxContainer = document.getElementById('messageBoxContainer');

        const homeButton = document.getElementById('homeButton');
        const validatorAuthButton = document.getElementById('validatorAuthButton'); // New validator button
        const showAddCourseFormBtn = document.getElementById('showAddCourseFormBtn');
        const addCourseForm = document.getElementById('addCourseForm');
        const cancelAddCourseBtn = document.getElementById('cancelAddCourseBtn');
        const courseList = document.getElementById('courseList');
        const courseDetailsTitle = document.getElementById('courseDetailsTitle');
        const showAddTermFormBtn = document.getElementById('showAddTermFormBtn');
        const addTermForm = document.getElementById('addTermForm');
        const addTermFormTitle = document.getElementById('addTermFormTitle');
        const addTermSubmitBtn = document.getElementById('addTermSubmitBtn');
        const cancelAddTermBtn = document.getElementById('cancelAddTermBtn');
        const termList = document.getElementById('termList');
        const noTermsMessage = document.getElementById('noTermsMessage');
        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResults = document.getElementById('searchResults');
        const searchResultsList = document.getElementById('searchResultsList');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const courseSearchInput = document.getElementById('courseSearchInput');

        // --- Utility Functions ---

        // Function to show a custom message box
        function showMessageBox(message, type = 'info', callback = null) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'messageBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <button id="messageBoxOkBtn" class="px-6 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 transition">OK</button>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('messageBoxOkBtn').onclick = () => {
                messageBoxContainer.innerHTML = ''; // Clear message box
                if (callback) callback();
            };
        }

        // Function to show a custom confirmation box
        function showConfirmBox(message, onConfirm, onCancel) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'confirmBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmBoxYesBtn" class="px-6 py-2 rounded-md bg-emerald-500 text-white hover:bg-emerald-600 transition">Yes</button>
                    <button id="confirmBoxNoBtn" class="px-6 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition">No</button>
                </div>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('confirmBoxYesBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
                onConfirm();
            };
            document.getElementById('confirmBoxNoBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
                if (onCancel) onCancel();
            };
        }

        // Function to show a custom prompt box
        function showPromptBox(message, onConfirm) {
            const backdrop = document.createElement('div');
            backdrop.className = 'message-box-backdrop';
            backdrop.id = 'promptBackdrop';

            const box = document.createElement('div');
            box.className = 'message-box';
            box.innerHTML = `
                <p class="text-lg font-medium mb-4">${message}</p>
                <input type="password" id="promptInput" class="mb-4" placeholder="Enter secret key">
                <div class="flex justify-center gap-4">
                    <button id="promptBoxOkBtn" class="px-6 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 transition">OK</button>
                    <button id="promptBoxCancelBtn" class="px-6 py-2 rounded-md bg-gray-500 text-white hover:bg-gray-600 transition">Cancel</button>
                </div>
            `;

            messageBoxContainer.appendChild(backdrop);
            messageBoxContainer.appendChild(box);

            document.getElementById('promptBoxOkBtn').onclick = () => {
                const inputValue = document.getElementById('promptInput').value;
                messageBoxContainer.innerHTML = '';
                onConfirm(inputValue);
            };
            document.getElementById('promptBoxCancelBtn').onclick = () => {
                messageBoxContainer.innerHTML = '';
            };
        }


        // Function to switch views
        function showView(viewElement) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            viewElement.classList.remove('hidden');
        }

        // Generate a simple unique ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Determines the overall status of a term based on its language statuses
        function getOverallTermStatus(term) {
            let providedLanguages = 0;
            let validatedLanguages = 0;

            LANGUAGES.forEach(lang => {
                if (term[lang.key] && term[lang.key].text) {
                    providedLanguages++;
                    if (term[lang.key].status === 'Validated') {
                        validatedLanguages++;
                    }
                }
            });

            if (providedLanguages === 0) {
                return 'No Content'; // Should not happen if Hebrew is required
            } else if (validatedLanguages === providedLanguages) {
                return 'Fully Validated';
            } else if (validatedLanguages > 0) {
                return 'Partially Validated';
            } else {
                return 'Pending';
            }
        }

        // --- Render Functions ---

        // Renders the list of courses
        function renderCourses() {
            courseList.innerHTML = '';
            if (appData.courses.length === 0) {
                courseList.innerHTML = '<p class="text-gray-500 text-center col-span-full">No courses added yet. Be the first!</p>';
                return;
            }
            appData.courses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'card cursor-pointer hover:bg-blue-50 transition flex justify-between items-center';
                courseCard.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-700">${course.name}</h3>
                    <div class="flex gap-2">
                        ${isValidatorMode ? `<button class="btn-delete px-3 py-1 text-sm" data-course-id="${course.id}">Delete</button>` : ''}
                    </div>
                `;
                courseCard.querySelector('h3').onclick = () => viewCourseDetails(course.id);
                // Only attach delete event listener if the button exists
                const deleteBtn = courseCard.querySelector('.btn-delete');
                if (deleteBtn) {
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // Prevent card click
                        deleteCourse(course.id);
                    };
                }
                courseList.appendChild(courseCard);
            });
        }

        // Renders the list of terms for a specific course
        function renderTerms(courseId, searchTerm = '') {
            termList.innerHTML = '';
            const termsForCourse = appData.terms.filter(term => term.courseId === courseId);
            const filteredTerms = searchTerm
                ? termsForCourse.filter(term =>
                    // Search across all language texts and definition
                    LANGUAGES.some(lang =>
                        term[lang.key] && term[lang.key].text && term[lang.key].text.toLowerCase().includes(searchTerm.toLowerCase())
                    ) || term.definition.toLowerCase().includes(searchTerm.toLowerCase())
                )
                : termsForCourse;

            if (filteredTerms.length === 0) {
                noTermsMessage.classList.remove('hidden');
                return;
            } else {
                noTermsMessage.classList.add('hidden');
            }

            filteredTerms.forEach(term => {
                const termOverallStatus = getOverallTermStatus(term);
                let overallStatusClass = '';
                if (termOverallStatus === 'Fully Validated') {
                    overallStatusClass = 'status-overall-fully-validated';
                } else if (termOverallStatus === 'Partially Validated') {
                    overallStatusClass = 'status-overall-partially-validated';
                } else {
                    overallStatusClass = 'status-overall-pending';
                }

                // Display the Hebrew term as the main heading
                const mainTermDisplay = term.hebrew && term.hebrew.text ? term.hebrew.text : (term.english && term.english.text ? term.english.text : 'Untitled Term');

                const termCard = document.createElement('div');
                termCard.className = 'card';
                termCard.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2" dir="rtl">${mainTermDisplay}</h3>
                    <p class="text-gray-700 mb-4">${term.definition}</p>

                    <table class="term-table mb-4">
                        <thead>
                            <tr>
                                <th>Language</th>
                                <th>Translation</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${LANGUAGES.map(lang => {
                                const termLang = term[lang.key];
                                const hasText = termLang && termLang.text;
                                const status = hasText ? termLang.status : 'Not Provided';
                                const statusClass = hasText
                                    ? (status === 'Validated' ? 'status-validated' : 'status-pending')
                                    : 'status-not-provided';
                                const translationText = hasText ? termLang.text : 'N/A';
                                const dirAttribute = lang.dir === 'rtl' ? 'dir="rtl"' : '';

                                return `
                                    <tr>
                                        <td>${lang.name}</td>
                                        <td ${dirAttribute}>${translationText}</td>
                                        <td class="${statusClass}">${status}</td>
                                        <td>
                                            ${hasText && status === 'Pending' ?
                                                `<button class="btn-validate px-3 py-1 text-xs" data-term-id="${term.id}" data-lang-key="${lang.key}">Validate</button>` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="flex justify-between items-center mt-4">
                        <span class="text-sm ${overallStatusClass}">
                            Overall Status: ${termOverallStatus}
                        </span>
                        <div class="flex gap-2">
                            <button class="btn-edit px-3 py-1 text-sm" data-term-id="${term.id}">Edit</button>
                            <button class="btn-delete px-3 py-1 text-sm" data-term-id="${term.id}">Delete Term</button>
                        </div>
                    </div>
                `;
                termList.appendChild(termCard);

                // Add event listeners for validate buttons
                termCard.querySelectorAll('.btn-validate').forEach(button => {
                    button.onclick = () => {
                        const termId = button.dataset.termId;
                        const langKey = button.dataset.langKey;
                        validateTerm(termId, langKey);
                    };
                });

                // Add event listener for edit button
                termCard.querySelector('.btn-edit').onclick = () => editTerm(term.id);

                // Add event listener for delete button
                termCard.querySelector('.btn-delete').onclick = () => deleteTerm(term.id);
            });
        }

        // Renders search results
        function renderSearchResults(results) {
            searchResultsList.innerHTML = '';
            if (results.length === 0) {
                searchResultsList.innerHTML = '<p class="text-gray-500 col-span-full">No terms found matching your search.</p>';
                return;
            }
            results.forEach(term => {
                const termOverallStatus = getOverallTermStatus(term);
                let overallStatusClass = '';
                if (termOverallStatus === 'Fully Validated') {
                    overallStatusClass = 'status-overall-fully-validated';
                } else if (termOverallStatus === 'Partially Validated') {
                    overallStatusClass = 'status-overall-partially-validated';
                } else {
                    overallStatusClass = 'status-overall-pending';
                }

                // Display the Hebrew term as the main heading in search results
                const mainTermDisplay = term.hebrew && term.hebrew.text ? term.hebrew.text : (term.english && term.english.text ? term.english.text : 'Untitled Term');

                const termCard = document.createElement('div');
                termCard.className = 'card';
                termCard.innerHTML = `
                    <h3 class="text-lg font-semibold mb-1" dir="rtl">${mainTermDisplay}</h3>
                    <p class="text-gray-600 text-sm mb-2">${term.definition.substring(0, 100)}${term.definition.length > 100 ? '...' : ''}</p>
                    <p class="text-xs text-gray-500">Course: ${appData.courses.find(c => c.id === term.courseId)?.name || 'Unknown'}</p>
                    <span class="text-xs ${overallStatusClass}">
                        Overall Status: ${termOverallStatus}
                    </span>
                `;
                searchResultsList.appendChild(termCard);
            });
        }

        // --- Event Handlers ---

        // Handle validator login/logout
        validatorAuthButton.onclick = () => {
            if (isValidatorMode) {
                // Logout
                isValidatorMode = false;
                validatorAuthButton.textContent = 'Validator Login';
                showMessageBox('Logged out of Validator Mode.', 'info', renderCourses); // Re-render to hide buttons
            } else {
                // Login
                showPromptBox('Enter validator secret key:', (key) => {
                    if (key === VALIDATOR_SECRET_KEY) {
                        isValidatorMode = true;
                        validatorAuthButton.textContent = 'Validator Logout';
                        showMessageBox('Successfully logged into Validator Mode!', 'success', renderCourses); // Re-render to show buttons
                    } else {
                        showMessageBox('Invalid secret key. Access denied.', 'error');
                    }
                });
            }
        };


        // Handle adding a new course
        addCourseForm.onsubmit = (e) => {
            e.preventDefault();
            const courseName = document.getElementById('courseName').value.trim();
            if (courseName) {
                const newCourse = {
                    id: generateId(),
                    name: courseName
                };
                appData.courses.push(newCourse);
                saveData(appData);
                showMessageBox('Course added successfully!', 'success', () => {
                    addCourseForm.reset();
                    showView(homeView);
                    renderCourses();
                });
            } else {
                showMessageBox('Course name cannot be empty.', 'error');
            }
        };

        // Handle adding or editing a term
        addTermForm.onsubmit = (e) => {
            e.preventDefault();
            const termHebrew = document.getElementById('termHebrew').value.trim();
            const termDefinition = document.getElementById('termDefinition').value.trim();

            if (!termHebrew || !termDefinition || !currentCourseId) {
                showMessageBox('Hebrew term and definition are required.', 'error');
                return;
            }

            let termToUpdate = null;
            let termIndex = -1;

            if (currentTermId) { // Editing an existing term
                termIndex = appData.terms.findIndex(t => t.id === currentTermId);
                if (termIndex !== -1) {
                    termToUpdate = appData.terms[termIndex];
                }
            }

            if (!termToUpdate) { // Adding a new term
                termToUpdate = {
                    id: generateId(),
                    courseId: currentCourseId,
                };
                appData.terms.push(termToUpdate);
            }

            termToUpdate.definition = termDefinition;

            // Process all language fields
            LANGUAGES.forEach(lang => {
                const inputElement = document.getElementById(lang.inputId);
                const newText = inputElement ? inputElement.value.trim() : ''; // Get current input value

                const oldLangData = termToUpdate[lang.key];
                const oldText = oldLangData ? oldLangData.text : '';

                if (newText) { // If new text is provided
                    if (!oldLangData || newText !== oldText) {
                        // If it's a new translation or the text has changed, reset status to Pending
                        termToUpdate[lang.key] = {
                            text: newText,
                            status: 'Pending',
                            validatedBy: null
                        };
                    } else {
                        // If text is provided and hasn't changed, keep existing status
                        termToUpdate[lang.key] = {
                            text: newText,
                            status: oldLangData.status,
                            validatedBy: oldLangData.validatedBy
                        };
                    }
                } else { // If new text is empty (translation removed or not provided)
                    termToUpdate[lang.key] = null;
                }
            });

            saveData(appData);
            showMessageBox(currentTermId ? 'Term updated successfully!' : 'Term added successfully! Individual translations are pending validation.', 'success', () => {
                addTermForm.reset();
                currentTermId = null; // Clear editing state
                viewCourseDetails(currentCourseId); // Go back to course details
            });
        };

        // Function to prepare the form for editing a term
        function editTerm(termId) {
            currentTermId = termId;
            const term = appData.terms.find(t => t.id === termId);

            if (term) {
                addTermFormTitle.textContent = 'Edit Term';
                addTermSubmitBtn.textContent = 'Save Changes';

                document.getElementById('termDefinition').value = term.definition;

                LANGUAGES.forEach(lang => {
                    const inputElement = document.getElementById(lang.inputId);
                    if (inputElement) {
                        inputElement.value = term[lang.key] && term[lang.key].text ? term[lang.key].text : '';
                    }
                });

                showView(addTermView);
            } else {
                showMessageBox('Term not found for editing.', 'error');
                currentTermId = null; // Reset if term not found
            }
        }


        // Validate a term for a specific language using the secret key
        function validateTerm(termId, langKey) {
            showPromptBox(`Enter validator secret key for ${langKey} translation:`, (key) => {
                if (key === VALIDATOR_SECRET_KEY) {
                    const termIndex = appData.terms.findIndex(t => t.id === termId);
                    if (termIndex !== -1 && appData.terms[termIndex][langKey]) {
                        appData.terms[termIndex][langKey].status = 'Validated';
                        appData.terms[termIndex][langKey].validatedBy = 'Validator'; // Placeholder for validator ID
                        saveData(appData);
                        showMessageBox(`${langKey} translation validated successfully!`, 'success', () => {
                            renderTerms(currentCourseId); // Re-render terms for current course
                        });
                    } else {
                        showMessageBox(`Could not validate ${langKey} translation.`, 'error');
                    }
                } else {
                    showMessageBox('Invalid secret key. Translation not validated.', 'error');
                }
            });
        }

        // Delete a course
        function deleteCourse(courseId) {
            showConfirmBox('Are you sure you want to delete this course and all its terms?', () => {
                appData.courses = appData.courses.filter(c => c.id !== courseId);
                appData.terms = appData.terms.filter(t => t.courseId !== courseId); // Also delete associated terms
                saveData(appData);
                showMessageBox('Course and associated terms deleted.', 'info', () => {
                    renderCourses();
                    if (currentCourseId === courseId) {
                        currentCourseId = null; // Clear current course if deleted
                        showView(homeView);
                    }
                });
            });
        }

        // Delete a term
        function deleteTerm(termId) {
            showConfirmBox('Are you sure you want to delete this term?', () => {
                appData.terms = appData.terms.filter(t => t.id !== termId);
                saveData(appData);
                showMessageBox('Term deleted.', 'info', () => {
                    renderTerms(currentCourseId); // Re-render terms for current course
                });
            });
        }

        // Global search functionality
        globalSearchInput.onkeyup = () => {
            const query = globalSearchInput.value.trim().toLowerCase();
            if (query.length > 0) {
                const results = appData.terms.filter(term =>
                    // Search across all language texts and definition
                    LANGUAGES.some(lang =>
                        term[lang.key] && term[lang.key].text && term[lang.key].text.toLowerCase().includes(query)
                    ) || term.definition.toLowerCase().includes(query)
                );
                searchResults.classList.remove('hidden');
                renderSearchResults(results);
            } else {
                searchResults.classList.add('hidden');
            }
        };

        // Clear global search results
        clearSearchBtn.onclick = () => {
            globalSearchInput.value = '';
            searchResults.classList.add('hidden');
        };

        // Course-specific search functionality
        courseSearchInput.onkeyup = () => {
            renderTerms(currentCourseId, courseSearchInput.value.trim());
        };


        // --- Navigation Logic ---

        // Function to view course details
        function viewCourseDetails(id) {
            currentCourseId = id;
            const course = appData.courses.find(c => c.id === id);
            if (course) {
                courseDetailsTitle.textContent = course.name;
                courseSearchInput.value = ''; // Clear course search when navigating
                renderTerms(id);
                showView(courseDetailsView);
            } else {
                showMessageBox('Course not found.', 'error', () => {
                    showView(homeView);
                    renderCourses();
                });
                currentCourseId = null; // Reset current course ID if not found
            }
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderCourses(); // Initial render to show courses (with or without delete buttons)
            showView(homeView);
        });

        // Event listeners for navigation buttons
        homeButton.onclick = () => {
            showView(homeView);
            renderCourses();
            globalSearchInput.value = ''; // Clear global search
            searchResults.classList.add('hidden'); // Hide search results
            currentCourseId = null; // Reset current course ID
            currentTermId = null; // Reset editing state
        };
        showAddCourseFormBtn.onclick = () => showView(addCourseView);
        cancelAddCourseBtn.onclick = () => {
            addCourseForm.reset();
            showView(homeView);
        };
        showAddTermFormBtn.onclick = () => {
            // Prepare form for adding a new term
            addTermForm.reset();
            addTermFormTitle.textContent = 'Add New Term';
            addTermSubmitBtn.textContent = 'Add Term';
            currentTermId = null; // Ensure we're in "add new" mode
            showView(addTermView);
        };
        cancelAddTermBtn.onclick = () => {
            addTermForm.reset();
            currentTermId = null; // Clear editing state
            if (currentCourseId) {
                viewCourseDetails(currentCourseId); // Go back to course details if a course was selected
            } else {
                showView(homeView); // Otherwise go to home
            }
        };

        // --- Initial Data (for demonstration) ---
        // You can uncomment this to pre-populate some data for testing
        
        if (appData.courses.length === 0 && appData.terms.length === 0) {
            appData = {
                courses: [
                    { id: 'c1', name: 'Calculus 1' },
                    { id: 'c2', name: 'Algebra' },
                    { id: 'c3', name: 'Introduction to Python' },
                    { id: 'c4', name: 'General Biology' },
                    { id: 'c5', name: 'Organic Chemistry' }
                ],
                terms: [
                    {
                        id: 't1', courseId: 'c1', definition: 'The rate at which the value of a function changes with respect to a change in the independent variable.',
                        hebrew: { text: 'נגזרת', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Derivative', status: 'Pending', validatedBy: null },
                        russian: { text: 'Производная', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'مشتقة', status: 'Pending', validatedBy: null },
                        french: { text: 'Dérivée', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't2', courseId: 'c1', definition: 'A mathematical object that can be interpreted as an area, a generalization of mass, or the total change of a quantity whose rate of change is known.',
                        hebrew: { text: 'אינטגרל', status: 'Pending', validatedBy: null },
                        english: { text: 'Integral', status: 'Pending', validatedBy: null },
                        russian: null, // Not provided
                        arabic: { text: 'תכלית', status: 'Pending', validatedBy: null }, // Arabic for 'purpose' as an example
                        french: null // Not provided
                    },
                    {
                        id: 't3', courseId: 'c2', definition: 'A rectangular array of numbers, symbols, or expressions, arranged in rows and columns.',
                        hebrew: { text: 'מטריצה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Matrix', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'Матрица', status: 'Validated', validatedBy: 'Admin' },
                        arabic: { text: 'מصفوفة', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Matrice', status: 'Validated', validatedBy: 'Admin' }
                    },
                    {
                        id: 't4', courseId: 'c3', definition: 'A named storage location that contains a value.',
                        hebrew: { text: 'משתנה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Variable', status: 'Pending', validatedBy: null },
                        russian: { text: 'Переменная', status: 'Pending', validatedBy: null },
                        arabic: null,
                        french: null
                    },
                    {
                        id: 't5', courseId: 'c4', definition: 'The powerhouse of the cell, responsible for cellular respiration.',
                        hebrew: { text: 'מיטוכונדריה', status: 'Validated', validatedBy: 'Admin' },
                        english: { text: 'Mitochondria', status: 'Validated', validatedBy: 'Admin' },
                        russian: { text: 'מטריצה', status: 'Validated', validatedBy: 'Admin' }, // Example of Russian translation
                        arabic: { text: 'الميتוكوندريا', status: 'Validated', validatedBy: 'Admin' },
                        french: { text: 'Mitochondrie', status: 'Validated', validatedBy: 'Admin' }
                    }
                ]
            };
            saveData(appData);
        }
        
    </script>
</body>
</html>
